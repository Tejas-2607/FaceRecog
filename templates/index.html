{% extends "base.html" %}
{% block title %}Live Recognition - Face Recognition System{% endblock %}

{% block extra_css %}
<style>
  /* ‚îÄ‚îÄ Voice & Command UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .command-input-row {
    display: flex;
    gap: 0.5rem;
    align-items: stretch;
    margin-bottom: 0.75rem;
  }

  .input-command {
    flex: 1;
    padding: 0.75rem 1rem;
    background: rgba(15, 23, 42, 0.7);
    border: 1.5px solid #334155;
    border-radius: 0.6rem;
    color: var(--white);
    font-size: 0.95rem;
    transition: border-color 0.25s, box-shadow 0.25s;
  }

  .input-command:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.18);
  }

  .input-command.voice-active {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.22);
    animation: borderPulse 1s infinite;
  }

  @keyframes borderPulse {
    0%, 100% { box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.22); }
    50%       { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.10); }
  }

  .btn-mic {
    width: 42px;
    height: 42px;
    flex-shrink: 0;
    border-radius: 0.6rem;
    border: 1.5px solid rgba(16, 185, 129, 0.45);
    background: rgba(16, 185, 129, 0.12);
    color: #10b981;
    font-size: 1.15rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.22s;
  }

  .btn-mic:hover {
    background: rgba(16, 185, 129, 0.25);
    transform: scale(1.07);
  }

  .btn-mic.recording {
    background: rgba(239, 68, 68, 0.18);
    border-color: rgba(239, 68, 68, 0.6);
    color: #ef4444;
    animation: micPulse 1s infinite;
  }

  @keyframes micPulse {
    0%, 100% { transform: scale(1);    box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
    50%       { transform: scale(1.08); box-shadow: 0 0 0 6px rgba(239,68,68,0); }
  }

  .voice-status-bar {
    display: none;
    align-items: center;
    gap: 0.6rem;
    padding: 0.55rem 0.9rem;
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.35);
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    color: #f87171;
  }

  .voice-status-bar.visible { display: flex; }

  .voice-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #ef4444;
    animation: blink 1s infinite;
    flex-shrink: 0;
  }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .voice-status-text { flex: 1; }

  .btn-cancel-voice {
    padding: 0.25rem 0.65rem;
    border-radius: 0.375rem;
    border: 1px solid rgba(239,68,68,0.4);
    background: rgba(239,68,68,0.15);
    color: #f87171;
    font-size: 0.78rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-cancel-voice:hover {
    background: rgba(239,68,68,0.35);
    color: #fff;
  }

  .command-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .btn-primary-full, .btn-secondary-full {
    flex: 1;
    padding: 0.7rem;
    border: none;
    border-radius: 0.55rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.22s;
    font-size: 0.9rem;
    letter-spacing: 0.01em;
  }

  .btn-primary-full {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #fff;
  }

  .btn-primary-full:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(79,70,229,0.45);
  }

  .btn-secondary-full {
    background: rgba(100,116,139,0.22);
    color: #cbd5e1;
    border: 1px solid rgba(100,116,139,0.4);
  }

  .btn-secondary-full:hover {
    background: rgba(100,116,139,0.4);
    color: #fff;
  }

  .no-speech-note {
    font-size: 0.78rem;
    color: #64748b;
    text-align: center;
    margin-top: 0.4rem;
    display: none;
  }

  .command-examples-mini {
    margin-top: 1rem;
    padding-top: 0.9rem;
    border-top: 1px solid rgba(51,65,85,0.5);
  }

  .example-label {
    font-size: 0.8rem;
    color: #64748b;
    margin-bottom: 0.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .examples-grid {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .example-cmd {
    display: block;
    padding: 0.45rem 0.7rem;
    background: rgba(15,23,42,0.55);
    border: 1px solid #334155;
    border-radius: 0.4rem;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.22s;
    color: #818cf8;
    font-family: 'Courier New', monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .example-cmd:hover {
    background: rgba(79,70,229,0.18);
    border-color: #6366f1;
    transform: translateX(4px);
    color: #a5b4fc;
  }

  .feedback-box {
    padding: 0.65rem 0.9rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    min-height: 2.2rem;
  }

  .feedback-success {
    background: rgba(16,185,129,0.15);
    color: #34d399;
    border: 1px solid rgba(16,185,129,0.3);
  }

  .feedback-error {
    background: rgba(239,68,68,0.15);
    color: #f87171;
    border: 1px solid rgba(239,68,68,0.3);
  }

  /* ‚îÄ‚îÄ VERIFICATION MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .verification-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    animation: fadeIn 0.3s;
  }

  .verification-modal.visible {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 2px solid #475569;
    border-radius: 1.2rem;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2rem;
    animation: slideUp 0.3s;
    position: relative;
  }

  @keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(71, 85, 105, 0.5);
  }

  .modal-title {
    font-size: 1.75rem;
    color: #fff;
    font-weight: 700;
  }

  .btn-close-modal {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #ef4444;
    padding: 0.5rem 1rem;
    border-radius: 0.6rem;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 700;
  }

  .btn-close-modal:hover {
    background: #ef4444;
    color: #fff;
  }

  .modal-body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .snapshot-preview {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .snapshot-preview h3 {
    font-size: 1.2rem;
    color: #cbd5e1;
    margin-bottom: 0.5rem;
  }

  .snapshot-preview img {
    width: 100%;
    border-radius: 0.75rem;
    border: 2px solid #475569;
    background: #0f172a;
  }

  .verification-info {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .info-field {
    background: rgba(15, 23, 42, 0.6);
    padding: 1rem;
    border-radius: 0.6rem;
    border: 1px solid #334155;
  }

  .info-label {
    font-size: 0.85rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .info-value {
    font-size: 1.1rem;
    color: #fff;
    font-weight: 600;
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .btn-modal-action {
    flex: 1;
    min-width: 200px;
    padding: 1rem 1.5rem;
    border: none;
    border-radius: 0.7rem;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.25s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
  }

  .btn-save {
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff;
  }

  .btn-save:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.5);
  }

  .btn-discard {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #f87171;
  }

  .btn-discard:hover {
    background: #ef4444;
    color: #fff;
  }

  /* Sketch generation UI */
  .sketch-option {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(71, 85, 105, 0.5);
  }

  .sketch-checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    color: #cbd5e1;
    font-size: 1rem;
    font-weight: 600;
  }

  .sketch-checkbox-label input {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .sketch-preview {
    margin-top: 1.5rem;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.5);
    border-radius: 0.6rem;
    text-align: center;
  }

  .sketch-preview img {
    width: 100%;
    max-height: 400px;
    object-fit: contain;
    border-radius: 0.5rem;
    border: 2px solid #475569;
    background: #fff;
  }

  .sketch-status {
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-weight: 600;
  }

  .sketch-status.processing {
    background: rgba(14, 165, 233, 0.15);
    color: #38bdf8;
  }

  .sketch-status.success {
    background: rgba(16, 185, 129, 0.15);
    color: #34d399;
  }

  .sketch-status.error {
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
  }

  /* Responsive modal */
  @media (max-width: 900px) {
    .modal-body {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="main-layout">

  <!-- ‚îÄ‚îÄ Left: Video ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="video-section-main">
    <div class="video-header">
      <h2>üé• Live Recognition</h2>
      <div class="status-indicator">
        <span id="datasetStatus"  class="status-badge">Loading...</span>
        <span id="commandStatus"  class="status-badge">No command</span>
      </div>
    </div>

    <div class="video-container-large">
      <img id="videoFeed" src="{{ url_for('video_feed') }}" alt="Live Video Feed" />
    </div>

    <div id="noDatasetWarning" class="warning-message" style="display:none">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <span class="warning-text">No persons in dataset. Please add users first.</span>
      <a href="/capture" class="btn-warning-link">Add User</a>
    </div>

    <div id="snapshotArea" class="snapshot-display" style="display:none">
      <div class="snapshot-header">
        <h3>üì∏ Latest Snapshot</h3>
        <button id="closeSnapshot" class="btn-close-snap">‚úï</button>
      </div>
      <img id="snapshotImage" src="" alt="Snapshot" />
      <div class="snapshot-info">
        <span id="snapshotTime"></span>
        <span id="snapshotPerson"></span>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Right: Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <div class="controls-section">

    <!-- Command Input Card -->
    <div class="control-card">
      <h3>üéØ Command Control</h3>

      <div class="command-input-wrapper">
        <label>Enter or speak a command:</label>

        <div class="command-input-row">
          <input
            type="text"
            id="commandInput"
            placeholder="detect User1  OR  find person right to User1"
            class="input-command"
            autocomplete="off"
            spellcheck="false"
          />
          <button id="micBtn" class="btn-mic" title="Start voice input">
            üé§
          </button>
        </div>

        <div id="voiceStatusBar" class="voice-status-bar">
          <div class="voice-dot"></div>
          <span class="voice-status-text" id="voiceStatusText">Listening‚Ä¶</span>
          <button id="cancelVoiceBtn" class="btn-cancel-voice">‚úï Cancel</button>
        </div>

        <div class="command-buttons">
          <button id="executeBtn" class="btn-primary-full">‚ñ∂ Execute</button>
          <button id="clearBtn"   class="btn-secondary-full">‚úï Clear</button>
        </div>

        <div id="commandFeedback" class="feedback-box"></div>

        <p id="noSpeechNote" class="no-speech-note">
          ‚ö† Voice input not supported in this browser. Use text instead.
        </p>
      </div>

      <div class="command-examples-mini">
        <p class="example-label">Examples (click to use)</p>
        <div class="examples-grid">
          <code class="example-cmd" data-cmd="detect User1">detect User1</code>
          <code class="example-cmd" data-cmd="identify Alice">identify Alice</code>
          <code class="example-cmd" data-cmd="find person right to User1">find person right to User1</code>
          <code class="example-cmd" data-cmd="scan left side of Bob">scan left side of Bob</code>
          <code class="example-cmd" data-cmd="who is standing right of Sarah">who is standing right of Sarah</code>
        </div>
      </div>
    </div>

    <!-- Snapshot Control -->
    <div class="control-card">
      <h3>üì∑ Snapshot Control</h3>
      <div class="snapshot-controls">
        <button id="manualSnapshotBtn" class="btn-snapshot">
          <span class="btn-icon">üì∏</span>
          Manual Snapshot
        </button>
        <div class="snapshot-mode">
          <label class="checkbox-label">
            <input type="checkbox" id="autoSnapshotMode" checked />
            <span>Auto-capture on detection</span>
          </label>
        </div>
        <div id="snapshotStatus" class="status-text"></div>
      </div>
    </div>

    <!-- Detection Info -->
    <div class="control-card">
      <h3>‚ÑπÔ∏è Detection Info</h3>
      <div class="info-stats">
        <div class="stat-row">
          <span class="stat-label">Faces Detected:</span>
          <span id="faceCount"    class="stat-value">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Anchor Person:</span>
          <span id="anchorPerson" class="stat-value">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Target Found:</span>
          <span id="targetFound"  class="stat-value">-</span>
        </div>
      </div>
      <div id="detectedFaces" class="detected-faces-list"></div>
    </div>

    <!-- Quick Stats -->
    <div class="control-card control-card-compact">
      <h3>üìä System Status</h3>
      <div class="quick-stats">
        <div class="quick-stat">
          <div class="quick-stat-value" id="totalPersons">0</div>
          <div class="quick-stat-label">Persons</div>
        </div>
        <div class="quick-stat">
          <div class="quick-stat-value" id="totalEmbeddings">0</div>
          <div class="quick-stat-label">Embeddings</div>
        </div>
      </div>
    </div>

  </div><!-- .controls-section -->
</div><!-- .main-layout -->

<!-- ‚ïê‚ïê‚ïê VERIFICATION MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="verificationModal" class="verification-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üì∏ Verify Snapshot</h2>
      <button id="closeModal" class="btn-close-modal">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="snapshot-preview">
        <h3>Captured Image</h3>
        <img id="modalSnapshotImg" src="" alt="Captured snapshot" />
      </div>

      <div class="verification-info">
        <div class="info-field">
          <div class="info-label">Person Name</div>
          <div class="info-value" id="modalPersonName">‚Äî</div>
        </div>

        <div class="info-field">
          <div class="info-label">Position Context</div>
          <div class="info-value" id="modalPositionText">‚Äî</div>
        </div>

        <div class="info-field">
          <div class="info-label">Timestamp</div>
          <div class="info-value" id="modalTimestamp">‚Äî</div>
        </div>

        <div class="sketch-option">
          <label class="sketch-checkbox-label">
            <input type="checkbox" id="createSketchCheck" />
            <span>üé® Generate sketch diagram</span>
          </label>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button id="btnSaveSnapshot" class="btn-modal-action btn-save">
        ‚úì Save Verified Snapshot
      </button>
      <button id="btnDiscardSnapshot" class="btn-modal-action btn-discard">
        ‚úó Discard
      </button>
    </div>

    <div id="sketchPreviewSection" class="sketch-preview" style="display:none">
      <h3>‚ú® Generated Sketch</h3>
      <img id="sketchPreviewImg" src="" alt="Sketch" />
      <div id="sketchStatus" class="sketch-status"></div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* =====================================================================
   STATE
   ===================================================================== */
let autoSnapshotEnabled  = true;
let lastSnapshotTime     = 0;
let currentCommand       = null;
let pendingSnapshot      = null;  // Stores snapshot awaiting verification

/* =====================================================================
   VOICE INPUT
   ===================================================================== */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition || null;

let recognition   = null;
let isRecording   = false;
let voiceAborted  = false;

const micBtn          = document.getElementById('micBtn');
const cancelVoiceBtn  = document.getElementById('cancelVoiceBtn');
const voiceStatusBar  = document.getElementById('voiceStatusBar');
const voiceStatusText = document.getElementById('voiceStatusText');
const commandInput    = document.getElementById('commandInput');
const noSpeechNote    = document.getElementById('noSpeechNote');

if (!SpeechRecognition) {
  micBtn.style.display = 'none';
  noSpeechNote.style.display = 'block';
} else {
  setupSpeechRecognition();
}

function setupSpeechRecognition() {
  recognition = new SpeechRecognition();
  recognition.lang            = 'en-US';
  recognition.interimResults  = true;
  recognition.maxAlternatives = 1;
  recognition.continuous      = false;

  recognition.onresult = (event) => {
    let interim   = '';
    let finalText = '';

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalText += transcript;
      } else {
        interim += transcript;
      }
    }

    if (finalText) {
      commandInput.value = finalText.trim();
      voiceStatusText.textContent = `‚úì Got: "${finalText.trim()}"`;
      stopRecording(false);
    } else if (interim) {
      commandInput.value = interim;
      voiceStatusText.textContent = `Listening‚Ä¶ "${interim}"`;
    }
  };

  recognition.onerror = (event) => {
    if (voiceAborted) return;
    const msgs = {
      'no-speech':     'No speech detected. Try again.',
      'audio-capture': 'Microphone not found or blocked.',
      'not-allowed':   'Microphone permission denied.',
      'network':       'Network error during speech recognition.',
    };
    voiceStatusText.textContent = msgs[event.error] || `Error: ${event.error}`;
    stopRecording(false);
  };

  recognition.onend = () => {
    if (voiceAborted) commandInput.value = '';
    stopRecording(false);
  };
}

micBtn.addEventListener('click', () => {
  if (isRecording) {
    stopRecording(true);
  } else {
    startRecording();
  }
});

cancelVoiceBtn.addEventListener('click', () => {
  stopRecording(true, true);
});

function startRecording() {
  if (!recognition) return;
  voiceAborted          = false;
  isRecording           = true;
  commandInput.value    = '';
  commandInput.classList.add('voice-active');
  micBtn.classList.add('recording');
  micBtn.title          = 'Recording‚Ä¶ click to stop';
  micBtn.textContent    = '‚èπ';
  voiceStatusBar.classList.add('visible');
  voiceStatusText.textContent = 'Listening‚Ä¶';

  try { recognition.start(); } catch(e) {}
}

function stopRecording(userStopped = false, cancel = false) {
  if (!isRecording && !cancel) return;

  if (cancel) voiceAborted = true;

  isRecording = false;
  commandInput.classList.remove('voice-active');
  micBtn.classList.remove('recording');
  micBtn.title     = 'Start voice input';
  micBtn.textContent = 'üé§';

  try { recognition.abort(); } catch(e) {}

  setTimeout(() => {
    voiceStatusBar.classList.remove('visible');
    voiceStatusText.textContent = 'Listening‚Ä¶';
    if (cancel) commandInput.value = '';
  }, cancel ? 0 : 1200);
}


/* =====================================================================
   COMMAND EXECUTION
   ===================================================================== */
function executeCommand() {
  const cmd         = commandInput.value.trim();
  const feedbackDiv = document.getElementById('commandFeedback');

  if (!cmd) {
    feedbackDiv.textContent  = '‚ö† Please enter or speak a command';
    feedbackDiv.className    = 'feedback-box feedback-error';
    return;
  }

  fetch('/api/set_command', {
    method:  'POST',
    headers: { 'Content-Type': 'application/json' },
    body:    JSON.stringify({ command: cmd }),
  })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        feedbackDiv.textContent = '‚úì ' + data.message;
        feedbackDiv.className   = 'feedback-box feedback-success';
        currentCommand          = data.command;
        const cs = document.getElementById('commandStatus');
        cs.textContent = '‚ñ∂ Active';
        cs.className   = 'status-badge status-active';
      } else {
        feedbackDiv.textContent = '‚úó ' + data.message;
        feedbackDiv.className   = 'feedback-box feedback-error';
      }
    })
    .catch(() => {
      feedbackDiv.textContent = '‚úó Network error';
      feedbackDiv.className   = 'feedback-box feedback-error';
    });
}

document.getElementById('executeBtn').addEventListener('click', executeCommand);

document.getElementById('commandInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') executeCommand();
});

document.getElementById('clearBtn').addEventListener('click', () => {
  commandInput.value = '';
  document.getElementById('commandFeedback').textContent = '';
  currentCommand = null;
  const cs = document.getElementById('commandStatus');
  cs.textContent = 'No command';
  cs.className   = 'status-badge';
  fetch('/api/clear_command', { method: 'POST' });
});

document.querySelectorAll('.example-cmd').forEach(el => {
  el.addEventListener('click', function() {
    commandInput.value = this.dataset.cmd;
    commandInput.focus();
  });
});


/* =====================================================================
   SNAPSHOT
   ===================================================================== */
document.getElementById('autoSnapshotMode').checked = autoSnapshotEnabled;
document.getElementById('autoSnapshotMode').addEventListener('change', function() {
  autoSnapshotEnabled = this.checked;
  document.getElementById('snapshotStatus').textContent =
    autoSnapshotEnabled ? '‚úì Auto-capture enabled' : '';
});

document.getElementById('manualSnapshotBtn').addEventListener('click', () => captureSnapshot());

document.getElementById('closeSnapshot').addEventListener('click', () => {
  document.getElementById('snapshotArea').style.display = 'none';
});

function captureSnapshot() {
  const now = Date.now();
  if (now - lastSnapshotTime < 2000) return;
  lastSnapshotTime = now;

  fetch('/api/capture_snapshot', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // Show in small preview
        showSnapshot(data.filename);
        
        // Open verification modal if auto-snapshot enabled
        if (autoSnapshotEnabled && currentCommand) {
          openVerificationModal(data.filename);
        }
        
        const ss = document.getElementById('snapshotStatus');
        ss.textContent = `‚úì Saved: ${data.filename}`;
        ss.className   = 'status-text status-success';
        setTimeout(() => { ss.textContent = ''; }, 3000);
      }
    })
    .catch(console.error);
}

function showSnapshot(filename) {
  document.getElementById('snapshotImage').src = `/api/get_snapshot/${filename}`;
  document.getElementById('snapshotTime').textContent = new Date().toLocaleTimeString();
  document.getElementById('snapshotArea').style.display = 'block';
}


/* =====================================================================
   VERIFICATION MODAL
   ===================================================================== */
const verificationModal  = document.getElementById('verificationModal');
const modalSnapshotImg   = document.getElementById('modalSnapshotImg');
const modalPersonName    = document.getElementById('modalPersonName');
const modalPositionText  = document.getElementById('modalPositionText');
const modalTimestamp     = document.getElementById('modalTimestamp');
const createSketchCheck  = document.getElementById('createSketchCheck');
const btnSaveSnapshot    = document.getElementById('btnSaveSnapshot');
const btnDiscardSnapshot = document.getElementById('btnDiscardSnapshot');
const sketchPreviewSection = document.getElementById('sketchPreviewSection');
const sketchPreviewImg   = document.getElementById('sketchPreviewImg');
const sketchStatus       = document.getElementById('sketchStatus');

document.getElementById('closeModal').addEventListener('click', closeVerificationModal);

function openVerificationModal(filename) {
  if (!currentCommand) return;

  pendingSnapshot = { filename: filename };

  // Fill modal data
  modalSnapshotImg.src = `/api/get_snapshot/${filename}`;
  modalPersonName.textContent = currentCommand.reference_person || 'Unknown';
  
  // Build position text
  let posText = '';
  if (currentCommand.mode === 'single') {
    posText = `Single detection of ${currentCommand.reference_person}`;
  } else {
    posText = `Person to the ${currentCommand.direction} of ${currentCommand.reference_person}`;
  }
  modalPositionText.textContent = posText;
  
  modalTimestamp.textContent = new Date().toLocaleString();
  createSketchCheck.checked = false;
  sketchPreviewSection.style.display = 'none';

  verificationModal.classList.add('visible');
}

function closeVerificationModal() {
  verificationModal.classList.remove('visible');
  pendingSnapshot = null;
}

btnSaveSnapshot.addEventListener('click', async () => {
  if (!pendingSnapshot) return;

  const createSketch = createSketchCheck.checked;

  const payload = {
    temp_filename: pendingSnapshot.filename,
    person_name: modalPersonName.textContent,
    position_desc: modalPositionText.textContent,
    create_sketch: createSketch
  };

  try {
    // Show processing if sketch requested
    if (createSketch) {
      sketchPreviewSection.style.display = 'block';
      sketchStatus.textContent = '‚è≥ Generating sketch...';
      sketchStatus.className = 'sketch-status processing';
    }

    const response = await fetch('/api/verify_snapshot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (data.success) {
      alert(`‚úì ${data.message}`);
      
      // Show sketch if generated
      if (data.sketch_filename) {
        sketchPreviewImg.src = `/api/get_snapshot/${data.sketch_filename}`;
        sketchStatus.textContent = '‚úì Sketch generated successfully!';
        sketchStatus.className = 'sketch-status success';
      }

      setTimeout(() => {
        closeVerificationModal();
      }, createSketch ? 3000 : 500);
    } else {
      alert(`‚úó ${data.message}`);
    }
  } catch (error) {
    alert('‚úó Error saving snapshot');
    console.error(error);
  }
});

btnDiscardSnapshot.addEventListener('click', async () => {
  if (!pendingSnapshot) return;
  if (!confirm('Discard this snapshot?')) return;

  try {
    await fetch('/api/discard_snapshot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filename: pendingSnapshot.filename })
    });
    closeVerificationModal();
  } catch (error) {
    console.error('Discard error:', error);
  }
});


/* =====================================================================
   SYSTEM STATUS
   ===================================================================== */
function checkDatasetStatus() {
  fetch('/api/system_status')
    .then(r => r.json())
    .then(data => {
      document.getElementById('totalPersons').textContent    = data.dataset_persons;
      document.getElementById('totalEmbeddings').textContent = data.embeddings_count;

      const warn = document.getElementById('noDatasetWarning');
      const ds   = document.getElementById('datasetStatus');

      if (!data.dataset_persons) {
        warn.style.display = 'flex';
        ds.textContent = '‚ö† No dataset';
        ds.className   = 'status-badge status-warning';
      } else if (!data.embeddings_loaded) {
        warn.style.display = 'flex';
        ds.textContent = '‚ö† No embeddings';
        ds.className   = 'status-badge status-warning';
      } else {
        warn.style.display = 'none';
        ds.textContent = `‚úì ${data.dataset_persons} persons`;
        ds.className   = 'status-badge status-success';
      }
    })
    .catch(console.error);
}

checkDatasetStatus();
setInterval(checkDatasetStatus, 10000);


/* =====================================================================
   DETECTION STATUS POLL
   ===================================================================== */
setInterval(() => {
  fetch('/api/detection_status')
    .then(r => r.json())
    .then(data => {
      const info = data.detection_info || {};
      document.getElementById('faceCount').textContent =
        info.total_faces ?? 0;
      document.getElementById('anchorPerson').textContent =
        info.anchor_detected ? (currentCommand?.reference_person ?? '-') : '-';
      document.getElementById('targetFound').textContent =
        info.target_detected ? '‚úì Yes' : '‚úó No';

      updateDetectedFacesList(info.faces);

      // Auto-snapshot when target detected (will open verification modal)
      if (autoSnapshotEnabled && currentCommand &&
          info.target_detected && Date.now() - lastSnapshotTime > 5000) {
        captureSnapshot();
      }
    })
    .catch(console.error);
}, 1000);

function updateDetectedFacesList(faces) {
  const el = document.getElementById('detectedFaces');
  if (!faces || !faces.length) {
    el.innerHTML = '<p class="no-faces">No faces detected</p>';
    return;
  }
  el.innerHTML = faces.map(f =>
    `<div class="face-item">
       <span class="face-name">${f.name}</span>
       <span class="face-score">${(f.score * 100).toFixed(1)}%</span>
     </div>`
  ).join('');
}
</script>
{% endblock %}
