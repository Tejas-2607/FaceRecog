{% extends "base.html" %} {% block title %}Live Recognition - Face Recognition
System{% endblock %} {% block content %}
<div class="main-layout">
  <!-- Left Side: Live Video (75%) -->
  <div class="video-section-main">
    <div class="video-header">
      <h2>üìπ Live Recognition</h2>
      <div class="status-indicator">
        <span id="datasetStatus" class="status-badge">Loading...</span>
        <span id="commandStatus" class="status-badge">No command</span>
      </div>
    </div>

    <div class="video-container-large">
      <img
        id="videoFeed"
        src="{{ url_for('video_feed') }}"
        alt="Live Video Feed"
      />
    </div>

    <!-- Warning message below video -->
    <div id="noDatasetWarning" class="warning-message" style="display: none">
      <span class="warning-icon">‚ö†Ô∏è</span>
      <span class="warning-text"
        >No persons in dataset. Please add users first.</span
      >
      <a href="/capture" class="btn-warning-link">Add User</a>
    </div>

    <!-- Snapshot Display Area -->
    <div id="snapshotArea" class="snapshot-display" style="display: none">
      <div class="snapshot-header">
        <h3>üì∏ Latest Snapshot</h3>
        <button id="closeSnapshot" class="btn-close-snap">‚úï</button>
      </div>
      <img id="snapshotImage" src="" alt="Snapshot" />
      <div class="snapshot-info">
        <span id="snapshotTime"></span>
        <span id="snapshotPerson"></span>
      </div>
    </div>
  </div>

  <!-- Right Side: Controls (25%) -->
  <div class="controls-section">
    <!-- Command Input -->
    <div class="control-card">
      <h3>üéØ Command Control</h3>
      <div class="command-input-wrapper">
        <label>Enter Command:</label>
        <input
          type="text"
          id="commandInput"
          placeholder="detect person right to User1"
          class="input-command"
        />
        <div class="command-buttons">
          <button id="executeBtn" class="btn-primary-full">‚ñ∂ Execute</button>
          <button id="clearBtn" class="btn-secondary-full">‚úï Clear</button>
        </div>
        <div id="commandFeedback" class="feedback-box"></div>
      </div>

      <div class="command-examples-mini">
        <p class="example-label">Examples:</p>
        <code class="example-cmd" data-cmd="detect person right to User1"
          >detect person right to User1</code
        >
        <code class="example-cmd" data-cmd="find second person left of User1"
          >find second person left of User1</code
        >
      </div>
    </div>

    <!-- Snapshot Control -->
    <div class="control-card">
      <h3>üì∑ Snapshot Control</h3>
      <div class="snapshot-controls">
        <button id="manualSnapshotBtn" class="btn-snapshot">
          <span class="btn-icon">üì∏</span>
          Manual Snapshot
        </button>
        <div class="snapshot-mode">
          <label class="checkbox-label">
            <input type="checkbox" id="autoSnapshotMode" />
            <span>Auto-capture on detection</span>
          </label>
        </div>
        <div id="snapshotStatus" class="status-text"></div>
      </div>
    </div>

    <!-- Detection Info -->
    <div class="control-card">
      <h3>‚ÑπÔ∏è Detection Info</h3>
      <div class="info-stats">
        <div class="stat-row">
          <span class="stat-label">Faces Detected:</span>
          <span id="faceCount" class="stat-value">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Anchor Person:</span>
          <span id="anchorPerson" class="stat-value">-</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">Target Found:</span>
          <span id="targetFound" class="stat-value">-</span>
        </div>
      </div>
      <div id="detectedFaces" class="detected-faces-list"></div>
    </div>

    <!-- Quick Stats -->
    <div class="control-card control-card-compact">
      <h3>üìä System Status</h3>
      <div class="quick-stats">
        <div class="quick-stat">
          <div class="quick-stat-value" id="totalPersons">0</div>
          <div class="quick-stat-label">Persons</div>
        </div>
        <div class="quick-stat">
          <div class="quick-stat-value" id="totalEmbeddings">0</div>
          <div class="quick-stat-label">Embeddings</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let autoSnapshotEnabled = false;
  let lastSnapshotTime = 0;
  let currentCommand = null;
  let lastDetection = null;

  // Check dataset status on load
  function checkDatasetStatus() {
    fetch("/api/system_status")
      .then((res) => res.json())
      .then((data) => {
        const hasDataset = data.dataset_persons > 0;
        const hasEmbeddings = data.embeddings_loaded;

        document.getElementById("totalPersons").textContent =
          data.dataset_persons;
        document.getElementById("totalEmbeddings").textContent =
          data.embeddings_count;

        if (!hasDataset) {
          document.getElementById("noDatasetWarning").style.display = "flex";
          document.getElementById("datasetStatus").textContent =
            "‚ö†Ô∏è No dataset";
          document.getElementById("datasetStatus").className =
            "status-badge status-warning";
        } else if (!hasEmbeddings) {
          document.getElementById("noDatasetWarning").style.display = "flex";
          document.getElementById("datasetStatus").textContent =
            "‚ö†Ô∏è No embeddings";
          document.getElementById("datasetStatus").className =
            "status-badge status-warning";
        } else {
          document.getElementById("noDatasetWarning").style.display = "none";
          document.getElementById("datasetStatus").textContent =
            `‚úì ${data.dataset_persons} persons`;
          document.getElementById("datasetStatus").className =
            "status-badge status-success";
        }
      })
      .catch((err) => console.error("Status check failed:", err));
  }

  // Execute command
  document.getElementById("executeBtn").addEventListener("click", function () {
    const command = document.getElementById("commandInput").value.trim();
    const feedbackDiv = document.getElementById("commandFeedback");

    if (!command) {
      feedbackDiv.textContent = "‚ö†Ô∏è Please enter a command";
      feedbackDiv.className = "feedback-box feedback-error";
      return;
    }

    fetch("/api/set_command", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ command: command }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          feedbackDiv.textContent = "‚úì " + data.message;
          feedbackDiv.className = "feedback-box feedback-success";
          currentCommand = data.command;
          document.getElementById("commandStatus").textContent = "‚ñ∂ Active";
          document.getElementById("commandStatus").className =
            "status-badge status-active";
        } else {
          feedbackDiv.textContent = "‚úó " + data.message;
          feedbackDiv.className = "feedback-box feedback-error";
        }
      })
      .catch((err) => {
        feedbackDiv.textContent = "‚úó Error executing command";
        feedbackDiv.className = "feedback-box feedback-error";
      });
  });

  // Clear command
  document.getElementById("clearBtn").addEventListener("click", function () {
    document.getElementById("commandInput").value = "";
    document.getElementById("commandFeedback").textContent = "";
    currentCommand = null;
    document.getElementById("commandStatus").textContent = "No command";
    document.getElementById("commandStatus").className = "status-badge";

    fetch("/api/clear_command", { method: "POST" });
  });

  // Example commands
  document.querySelectorAll(".example-cmd").forEach((cmd) => {
    cmd.addEventListener("click", function () {
      document.getElementById("commandInput").value = this.dataset.cmd;
    });
  });

  // Manual snapshot
  document
    .getElementById("manualSnapshotBtn")
    .addEventListener("click", function () {
      captureSnapshot("manual");
    });

  // Auto-snapshot toggle
  document
    .getElementById("autoSnapshotMode")
    .addEventListener("change", function () {
      autoSnapshotEnabled = this.checked;
      document.getElementById("snapshotStatus").textContent =
        autoSnapshotEnabled ? "‚úì Auto-capture enabled" : "";
    });

  // Capture snapshot function
  function captureSnapshot(mode) {
    const now = Date.now();
    if (now - lastSnapshotTime < 2000) return; // Prevent spam
    lastSnapshotTime = now;

    fetch("/api/capture_snapshot", { method: "POST" })
      .then((res) => res.json())
      .then((data) => {
        if (data.success) {
          showSnapshot(data.filename, data.person_name || "Unknown");
          document.getElementById("snapshotStatus").textContent =
            `‚úì Snapshot saved: ${data.filename}`;
          document.getElementById("snapshotStatus").className =
            "status-text status-success";
          setTimeout(() => {
            document.getElementById("snapshotStatus").textContent = "";
          }, 3000);
        }
      })
      .catch((err) => console.error("Snapshot failed:", err));
  }

  // Show snapshot in UI
  function showSnapshot(filename, personName) {
    const snapshotArea = document.getElementById("snapshotArea");
    const snapshotImage = document.getElementById("snapshotImage");
    const snapshotTime = document.getElementById("snapshotTime");
    const snapshotPerson = document.getElementById("snapshotPerson");

    snapshotImage.src = `/api/get_snapshot/${filename}`;
    snapshotTime.textContent = new Date().toLocaleTimeString();
    snapshotPerson.textContent = personName;
    snapshotArea.style.display = "block";
  }

  // Close snapshot
  document
    .getElementById("closeSnapshot")
    .addEventListener("click", function () {
      document.getElementById("snapshotArea").style.display = "none";
    });

  // Poll for detection updates
  setInterval(() => {
    fetch("/api/detection_status")
      .then((res) => res.json())
      .then((data) => {
        if (data.detection_info) {
          const info = data.detection_info;
          document.getElementById("faceCount").textContent =
            info.total_faces || 0;
          document.getElementById("anchorPerson").textContent =
            info.anchor_detected ? currentCommand?.reference_person : "-";
          document.getElementById("targetFound").textContent =
            info.target_detected ? "‚úì Yes" : "‚úó No";

          // Auto-snapshot logic
          if (
            autoSnapshotEnabled &&
            currentCommand &&
            info.target_detected &&
            Date.now() - lastSnapshotTime > 5000
          ) {
            captureSnapshot("auto");
          }

          // Update detected faces list
          updateDetectedFacesList(info.faces);
          lastDetection = info;
        }
      })
      .catch((err) => console.error("Detection poll failed:", err));
  }, 1000); // Poll every second

  // Update detected faces list
  function updateDetectedFacesList(faces) {
    const listDiv = document.getElementById("detectedFaces");
    if (!faces || faces.length === 0) {
      listDiv.innerHTML = '<p class="no-faces">No faces detected</p>';
      return;
    }

    listDiv.innerHTML = faces
      .map(
        (face) =>
          `<div class="face-item">
            <span class="face-name">${face.name}</span>
            <span class="face-score">${(face.score * 100).toFixed(1)}%</span>
        </div>`,
      )
      .join("");
  }

  // Initialize
  async function initializePage() {
    // Ensure server has camera access
    try {
      await fetch("/api/acquire_camera", { method: "POST" });
      console.log("Server camera acquired");
    } catch (err) {
      console.error("Failed to acquire server camera:", err);
    }

    checkDatasetStatus();
  }

  initializePage();
  setInterval(checkDatasetStatus, 10000); // Check every 10 seconds

  // Allow Enter key for command
  document
    .getElementById("commandInput")
    .addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        document.getElementById("executeBtn").click();
      }
    });
</script>
{% endblock %}
